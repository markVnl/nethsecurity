#!/bin/bash
#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

#
# Create a single ext4 partition on the given device.
# Parameters:
# - device, like '/dev/sdb'
#

set -e

eerror()
{
    echo "ERROR: $1"
    exit 1
}

device=$1

[ -z "$device" ] && eerror "Device '$device' not found"
[ ! -e "/sys/class/block/$(basename "$device")" ] && eerror "Device '$device' is not a block device"
mount | grep -q "$device" && eerror "Device '$device' is already mounted"

# handle nvme and multimedia cards 
if [[ "$device" =~ ^/dev/nvme ]] || [[ "$device" =~ ^/dev/mmcblk ]]; then
  partition="${device}p1"
else
  partition="${device}1"
fi

# cleanup partitions
dd if=/dev/zero of="$device" bs=512 count=1 conv=notrunc 2>/dev/null
# create a single ext4 partition
parted -s -a optimal "$device" mklabel gpt -- mkpart primary  1 -1 >/dev/null
mkfs.ext4 -q -F -L ns_data "$partition" >/dev/null
echo '{"device": "'${partition}'"}'
